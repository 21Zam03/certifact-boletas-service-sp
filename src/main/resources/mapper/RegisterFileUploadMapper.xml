<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.certicom.certifact_boletas_service_sp.mapper.RegisterFileUploadMapper">
    <insert id="save"
            parameterType="com.certicom.certifact_boletas_service_sp.model.RegisterFileUploadModel"
            useGeneratedKeys="true" keyProperty="idRegisterFileSend" keyColumn="id_register_file_send">
        INSERT INTO register_file_upload (id_register_file_send, bucket, nombre_generado, nombre_archivo, cod_company, estado, fecha_upload)
        VALUES (nextval('file_upload_seq'), #{bucket}, #{nombreGenerado}, #{nombreOriginal}, #{codCompany}, #{estado}, #{fechaUpload})
    </insert>
    <select id="findById"
            parameterType="java.lang.Long"
            resultType="com.certicom.certifact_boletas_service_sp.model.RegisterFileUploadModel">
        SELECT
        *
        FROM register_file_upload
        WHERE id_register_file_send = #{id}
    </select>
    <select id="findFirst1ByPaymentVoucherIdPaymentVoucherAndTipoArchivoAndEstadoArchivoOrderByOrdenDesc">
        SELECT pv.id_payment_voucher AS id,
        u.is_old AS isOld,
        u.bucket,
        u.nombre_generado AS nombreGenerado,
        u.ruc_company AS rucCompany,
        u.uuid,
        u.extension,
        pvf.tipo_archivo AS tipo
        FROM register_file_upload u
        INNER JOIN payment_voucher_file pvf
        ON pvf.id_register_file_send = u.id_register_file_send
        INNER JOIN payment_voucher pv
        ON pv.id_payment_voucher = pvf.id_payment_voucher
        WHERE pv.id_payment_voucher = #{id}
        AND pvf.tipo_archivo = #{tipo}
        AND estado_archivo = #{estado}
        ORDER BY u.id_register_file_send DESC
        LIMIT 1
    </select>
    <select id="getDataForCdr">
        select
            <!--sd.id_document_summary,-->
            u.is_old,
            u.bucket,
            u.nombre_generado,
            u.ruc_company,
            u.uuid,
            u.extension
        from register_file_upload u
        inner join summary_file sf on sf.id_register_file_send = u.id_register_file_send
        inner join summary_documents sd on sd.id_document_summary = sd.id_document_summary
        where sd.id_document_summary = #{id} and sf.tipo_archivo = #{tipo} order by u.id_register_file_send desc limit 1;
    </select>
    <select id="getDataForXml">
        SELECT
            pv.id_payment_voucher AS id,
            u.is_old AS isOld,
            u.bucket,
            u.nombre_generado AS nombreGenerado,
            u.ruc_company AS rucCompany,
            u.uuid,
            u.extension,
            pvf.tipo_archivo AS tipo
        FROM register_file_upload u
                 INNER JOIN payment_voucher_file pvf
                            ON pvf.id_register_file_send = u.id_register_file_send
                 INNER JOIN payment_voucher pv
                            ON pv.id_payment_voucher = pvf.id_payment_voucher
        WHERE pv.id_payment_voucher = #{id}
          AND pv.uuid = #{uuid}
          AND pvf.tipo_archivo = #{tipo}
        ORDER BY u.id_register_file_send DESC
            LIMIT 1
    </select>
</mapper>